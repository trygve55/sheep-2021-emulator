# sheep-2021-emulator
Python scripts to emulate different parts of the sheepRTT system. Only tested on linux.

## Install
```bash
git clone --recurse-submodules https://github.com/trygve55/sheep-2021-emulator
cd sheep-2021-emulator
python3 -m venv .
source bin/activate
pip install lxml future pyserial
cd mavlink
python -m pymavlink.tools.mavgen --lang=Python --wire-protocol=2.0 --output=pymavlink/dialects/v20/sheeprtt_ardupilotmega.py message_definitions/v1.0/sheeprtt_ardupilotmega.xml
cd pymavlink
python setup.py install
```

## Components
### Main(module)
Emulates the MAVLINK traffic generated by the nRF52833.

### GCS-addon
The part of the GCS software dealing with sheepRTT related packets.

### Drone
Emulates a drone moving slowly. Responds to REQUEST_DATA_STREAM messages and sends out a heartbeat. You should use the ArduPilot SITL instead.

### Module_tests
Runs a series of test to confirm that the functionality is implemented correctly on the module. Can also be run against main.py.

## Running
Connecting to drone via usb serial to emulate the sheepRTT nRF52833.
```bash
python main.py /dev/ttyUSB0 57600
```
Connecting gcs-addon to Mission Planner MAVLINK mirror. In Mission Planner press ctrl+f then click on "Mavlink", select "TCP HOST - 14550", enable write access and Connect.
```bash
python gcs-addon.py tcp:<ipadress>:14550
```
Start drone emulator listening in TCP port 14530.
```bash
python drone.py tcpin:localhost:14530
```
Connecting to drone emulator via TCP to emulate the sheepRTT nRF52833.
```bash
python main.py tcp:localhost:14530
```
Connecting to ArduPilot SITL via TCP to emulate the sheepRTT nRF52833.
```bash
python main.py tcp:localhost:5763
```

Connecting to module via usb serial to emulate the sheepRTT nRF52833.
```bash
python module_tests.py /dev/ttyUSB0 57600
```

## Wireshark MAVLink dissector setup

### Setup
Skip this step if you have already completed the installation instructions above.
```bash
git clone --recurse-submodules https://github.com/trygve55/sheep-2021-emulator
cd sheep-2021-emulator
python3 -m venv .
source bin/activate
pip install lxml future pyserial
```

### Generate Lua dissector
```bash
cd mavlink
python -m pymavlink.tools.mavgen --lang=WLua --wire-protocol=2.0 --output=pymavlink/dialects/v20/mavlink_sheeprtt_ardupilotmega.lua message_definitions/v1.0/sheeprtt_ardupilotmega.xml
```
Copy the generated mavlink_*.lua file to Wireshark's Personal(or Global) Lua Plugins folder. The plugins folder can be found by opening Wireshark, clicking "Help", "About Wireshark" and going to the Folders tab.

### Set the correct port and UDP/TCP
You may need to make a few changes to your Lua dissector to make it work with other than UDP port 14550 and 14580.


Last few lines of Lua dissector:
```lua
local udp_dissector_table = DissectorTable.get("udp.port")
udp_dissector_table:add(14550, mavlink_proto)
udp_dissector_table:add(14580, mavlink_proto)
```
Example with TCP port 14530 added:
```lua
local udp_dissector_table = DissectorTable.get("udp.port")
udp_dissector_table:add(14550, mavlink_proto)
udp_dissector_table:add(14580, mavlink_proto)
local tcp_dissector_table = DissectorTable.get("tcp.port")
tcp_dissector_table:add(14530, mavlink_proto)
```

### Note
You may be denied from loading the Lua dissector if you run Wireshark as root. To solve this follow these steps. https://superuser.com/questions/319865/how-to-set-up-wireshark-to-run-without-root-on-debian
